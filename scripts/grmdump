#!/usr/bin/make -f

PACKAGE      = cdmtools
release     ?= 39
FTP_BASEDIR ?= "ftp://anonymous@ftp.gramene.org/pub/gramene/release$(release)/data"
FASTADIR    ?= "$(FTP_BASEDIR)/fasta"
GFFDIR      ?= "$(FTP_BASEDIR)/gff"
STAGING_DIR ?= "./staging/gramene/$(release)"
ESEARCH      = "http://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=taxonomy&field=Scientific+Name&term="
EFETCH       = "http://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=taxonomy&id="
CURL         = "curl"

genome ?=
stage_dir = $(STAGING_DIR)/$(genome)
dump_dir  = $(stage_dir)/dump

define USAGE
grmdump [options] <command> [<arguments>]

Available options:
  FTP_BASEDIR=<path>: FTP path to use for fetching genomes
    Default: $(FTP_BASEDIR)
  STAGING_DIR=<path>: Staging directory to use
    Default: $(STAGING_DIR)
	  
Available commands:
  run		  Run entire pipeline from scratch
  genomes	  Fetch available genomes
  dump		  Just dump the raw Gramene data sets
  package	  Package the files for submission
  help		  This help message
  gff		  Dump GFF
 
Currently no command-arguments are supported.
endef
export USAGE

help:
	@ echo "$$USAGE"

init:
	@ echo "Initializing"
	@ mkdir -p $(STAGING_DIR)

$(stage_dir):
	@ mkdir -p $(stage_dir)

$(dump_dir):
	@ mkdir -p $(dump_dir)

$(dump_dir)/assembly.fa.gz:
	@ if [ ! -e "$(dump_dir)/.done.assembly" ]; then \
		echo "Fetching genome contigs"; \
		fname=`$(CURL) -s -l $(FASTADIR)/$(genome)/dna/ | \
			grep '.dna.toplevel.fa.gz'`; \
		$(CURL) -C - $(FASTADIR)/$(genome)/dna/$$fname -o $(dump_dir)/assembly.fa.gz; \
		touch $(dump_dir)/.done.assembly; \
	fi

$(dump_dir)/annotation_info.txt.gz:
	@ echo "Fetching annotation info"

$(dump_dir)/proteins.fa.gz:
	@ if [ ! -e "$(dump_dir)/.done.proteins" ]; then \
		echo "Fetching proteins"; \
		fname=`$(CURL) -s -l $(FASTADIR)/$(genome)/pep/ | \
		grep '.pep.all.fa.gz'`; \
		$(CURL) -C - $(FASTADIR)/$(genome)/pep/$$fname -o $(dump_dir)/proteins.fa.gz; \
		touch $(dump_dir)/.done.proteins; \
	fi

$(dump_dir)/genes.gff.gz:
	@ if [ ! -e "$(dump_dir)/.done.gff" ]; then \
		echo "Fetching GFF data"; \
		$(CURL) -C - $(GFFDIR)/$(genome).gff.gz -o $(dump_dir)/genes.gff.gz; \
		touch $(dump_dir)/.done.gff; \
	fi

fetch-$(genome): $(stage_dir) $(dump_dir) \
	$(dump_dir)/assembly.fa.gz \
	$(dump_dir)/proteins.fa.gz \
	$(dump_dir)/annotation_info.txt.gz \
	$(dump_dir)/genes.gff.gz
	

package-$(genome): $(stage_dir)
	@ echo "Now packaging"

run: init fetch-$(genome) package-$(genome)
	@ echo "Running genome $(genome)"

.genomes.gramene:
	@ $(CURL) -s -l $(FASTADIR)/ > .genomes.gramene

genomes: .genomes.gramene
	@ echo "Available genomes:"
	@ cat .genomes.gramene
	
clean:
	@ rm -f .genomes.gramene
	@ find $(STAGING_DIR) -name ".done*" -exec rm {} \;
	

# function grm_cmd_dump {
#	  local genome=$1
#	  ftp_paths="
#	  $FTP_BASEDIR
#	  "
# 
#	  for path in `echo $ftp_paths`
#	  do
#		  wget -r -nc --no-directories \
#			  --accept "pep/*.pep.all.fa.gz" \
#			  --accept "dna/*.dna.toplevel.fa.gz" \
#		  $path
#	  done
# }
# 
# function grm_cmd_gff {
#	  local genome=$1
#	  wget -q "$GFF_BASEDIR/$genome.gff"
# }
# 
# function grm_cmd_package {
#	  local genome=$1
#	  if [ ! -e "$STAGING_DIR" ]; then
#		  echo "Staging directory $STAGING_DIR does not exist!"
#		  exit 1
#	  fi
#	  if [ -n "$genome" ]; then
#		  genomes=$STAGING_DIR/$genome
#		  if [ ! -d "$genomes" ]; then
#			  echo "Genome $genome not in the staging directory."
#			  exit 1
#		  fi
#	  else
#		  genomes=$STAGING_DIR/*
#	  fi
#	  
#	  for g in $genomes; do
#		  echo $g
#	  done
# }
# 
# function grm_cmd_genomes {
#	  rm -f .listing
#	  wget -q --no-remove-listing --level 1 -O - "$FTP_BASEDIR/" > /dev/null
#	  cat .listing | cut -c57- | grep -v '^\.*$' > .genomes
#	  cat .genomes
# }
# 
# function grm_cmd_run {
#	  grm_cmd_dump $@
#	  grm_cmd_package $@
# }
# 
# while getopts "s:f:" opt; do
#	  case $opt in
#		  s)
#			  STAGING_DIR="$OPTARG"
#			  ;;
#		  f)
#			  FTP_BASEDIR="$OPTARG"
#			  ;;
#		  *)
#			  echo "Unsupported option -$opt"
#			  iris_cmd_help
#			  ;;
#	  esac
# done
# shift $((OPTIND-1))
# 
# cmd=${1:-help}
# if [ `declare -f grm_cmd_$cmd | wc -l` -gt 1 ]; then
#	  shift
#	  eval "grm_cmd_$cmd \$@"
# else
#	  echo "Unrecognized command '$cmd'. Try '$0 help'."
# fi

.PHONY: help

all: $(genome)